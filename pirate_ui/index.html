<!DOCTYPE html>
<html>
<head>
    <title>Pirate UI</title>
    <meta charset="UTF-8">
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="formatting.js"></script>
    <style>
        body {
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: monospace;
            margin: 20px;
            font-size: 14px;
        }

        .section {
            background-color: #252526;
            border: 1px solid #3e3e42;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }

        h2 {
            color: #569cd6;
            margin-top: 0;
            font-size: 16px;
        }

        .status {
            display: flex;
            gap: 20px;
        }

        .online {
            color: #6A9955;
            font-size: 20px;
        }

        .offline {
            color: #F44747;
            font-size: 20px;
        }

        .error {
            color: #F44747;
            margin-bottom: 10px;
        }

        .overall-pnl {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .overall-pnl-item {
            background-color: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            text-align: left;
        }

        .overall-pnl-label {
            color: #9cdcfe;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .overall-pnl-value {
            font-size: 18px;
            font-weight: bold;
        }

        .currency {
            color: #808080;
            font-size: 12px;
            margin-left: 4px;
        }

        .profit {
            color: #6A9955;
        }

        .loss {
            color: #F44747;
        }

        .neutral {
            color: #d4d4d4;
        }

        .positions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .position {
            background-color: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 0;
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .position-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .position-symbol {
            color: #9cdcfe;
            font-size: 14px;
        }

        .position-category {
            color: #569cd6;
            font-size: 14px;
            opacity: 0.8;
        }

        .position-change {
            font-size: 14px;
        }

        .position-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .position-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-label {
            color: #9cdcfe;
        }

        .detail-value {
            text-align: right;
            font-family: monospace;
        }

        .token-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .token-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .token {
            background-color: #2d2d2d;
            padding: 12px;
            border-radius: 5px;
        }

        .token-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .token-name {
            color: #9cdcfe;
            font-weight: bold;
            font-size: 14px;
        }

        .token-score {
            color: #569cd6;
            font-size: 14px;
        }

        .token-metrics {
            color: #808080;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }

        .recent-activity {
            max-height: 200px;
            overflow-y: auto;
        }

        .transaction {
            background-color: #2d2d2d;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .transaction-type {
            color: #9cdcfe;
            font-weight: bold;
        }

        .transaction-time {
            color: #808080;
        }

        .transaction-details {
            color: #d4d4d4;
            font-size: 12px;
        }

        .error-boundary {
            padding: 20px;
            background: #2a1a1a;
            border: 1px solid #F44747;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .retry-button {
            background: #569cd6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .retry-button:hover {
            background: #4e8ac7;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .connected {
            background: #6A9955;
            color: white;
        }
        
        .disconnected {
            background: #F44747;
            color: white;
        }
        
        .reconnecting {
            background: #569cd6;
            color: white;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Error Boundary Component
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false };
            }
            
            static getDerivedStateFromError(error) {
                return { hasError: true };
            }
            
            componentDidCatch(error, errorInfo) {
                console.error('Error caught by boundary:', error, errorInfo);
            }
            
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="error-boundary">
                            <h3>Something went wrong</h3>
                            <button 
                                className="retry-button"
                                onClick={() => {
                                    this.setState({ hasError: false });
                                    if (this.props.onRetry) {
                                        this.props.onRetry();
                                    }
                                }}
                            >
                                Retry
                            </button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }
        
        // Connection Status Component
        function ConnectionStatus({ status }) {
            const statusClass = {
                connected: 'connected',
                disconnected: 'disconnected',
                reconnecting: 'reconnecting'
            }[status];
            
            const statusText = {
                connected: 'Connected',
                disconnected: 'Disconnected',
                reconnecting: 'Reconnecting...'
            }[status];
            
            return (
                <div className={`connection-status ${statusClass}`}>
                    {statusText}
                </div>
            );
        }
        
        // Custom hook for WebSocket connection
        function useWebSocket(url, options = {}) {
            const [status, setStatus] = React.useState('disconnected');
            const [data, setData] = React.useState(null);
            const ws = React.useRef(null);
            const reconnectTimeout = React.useRef(null);
            const reconnectAttempts = React.useRef(0);
            const maxReconnectAttempts = options.maxReconnectAttempts || 5;
            const reconnectDelay = options.reconnectDelay || 1000;
            
            const connect = React.useCallback(() => {
                if (ws.current?.readyState === WebSocket.OPEN) {
                    return;
                }
                
                try {
                    ws.current = new WebSocket(url);
                    
                    ws.current.onopen = () => {
                        console.log('WebSocket connected');
                        setStatus('connected');
                        reconnectAttempts.current = 0;
                        
                        // Request full state on connection
                        ws.current.send(JSON.stringify({ type: 'request_full_state' }));
                    };
                    
                    ws.current.onmessage = (event) => {
                        const newData = JSON.parse(event.data);
                        setData(prevData => {
                            // Merge new data with existing state
                            if (newData.type === 'full_state') {
                                return newData.data;
                            } else {
                                return { ...prevData, ...newData };
                            }
                        });
                        
                        // Store positions in localStorage as backup
                        if (newData.positions) {
                            localStorage.setItem('positions', JSON.stringify(newData.positions));
                        }
                    };
                    
                    ws.current.onclose = () => {
                        console.log('WebSocket closed');
                        setStatus('disconnected');
                        
                        // Attempt to reconnect
                        if (reconnectAttempts.current < maxReconnectAttempts) {
                            setStatus('reconnecting');
                            reconnectTimeout.current = setTimeout(() => {
                                reconnectAttempts.current += 1;
                                connect();
                            }, reconnectDelay * Math.pow(2, reconnectAttempts.current));
                        }
                    };
                    
                    ws.current.onerror = (error) => {
                        console.error('WebSocket error:', error);
                    };
                    
                } catch (error) {
                    console.error('Error creating WebSocket:', error);
                }
            }, [url]);
            
            // Connect on mount
            React.useEffect(() => {
                connect();
                
                // Load positions from localStorage if available
                const savedPositions = localStorage.getItem('positions');
                if (savedPositions) {
                    setData(prevData => ({
                        ...prevData,
                        positions: JSON.parse(savedPositions)
                    }));
                }
                
                return () => {
                    if (ws.current) {
                        ws.current.close();
                    }
                    if (reconnectTimeout.current) {
                        clearTimeout(reconnectTimeout.current);
                    }
                };
            }, [connect]);
            
            return { status, data, connect };
        }
        
        function App() {
            const { status, data, connect } = useWebSocket('ws://localhost:8000/ws', {
                maxReconnectAttempts: 5,
                reconnectDelay: 1000
            });
            
            if (!data) {
                return (
                    <div className="section">
                        <h2>Loading...</h2>
                    </div>
                );
            }
            
            return (
                <ErrorBoundary onRetry={connect}>
                    <ConnectionStatus status={status} />
                    
                    <div className="section">
                        <h2>System Status</h2>
                        <SystemStatus data={data} />
                    </div>
                    
                    <ErrorBoundary>
                        <div className="section">
                            <h2>Portfolio</h2>
                            <Portfolio positions={data.positions || {}} />
                        </div>
                    </ErrorBoundary>
                    
                    <ErrorBoundary>
                        <div className="section">
                            <h2>Token Metrics</h2>
                            <TokenMetrics data={data.token_metrics || {}} />
                        </div>
                    </ErrorBoundary>
                    
                    <ErrorBoundary>
                        <div className="section">
                            <h2>Recent Activity</h2>
                            <RecentActivity transactions={data.recent_transactions || []} />
                        </div>
                    </ErrorBoundary>
                </ErrorBoundary>
            );
        }
        
        // ... rest of the components (SystemStatus, Portfolio, TokenMetrics, etc.) ...
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
